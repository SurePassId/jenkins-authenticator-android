pipeline {
  agent any

  environment {
    APP_TRACK_NAME="beta"
    APP_ROLLOUT_PERCENTAGE="100"
    GOOGLE_CREDENTIAL_ID="SurePassID Authenticator"
  }

  stages {
    stage('Copy Archived App Bundles') {
      steps {
        // TODO: need to find better way of tracking what is being moved.
        copyArtifacts projectName: '01_authenticator-android-build-master',
                      filter: '**/*.aab',
                      fingerprintArtifacts: true,
                      flatten: true,
                      selector: lastSuccessful()
      }
    }

    stage('Promote Black to Open Testing') {
      steps {
        androidApkMove filesPattern: 'authenticator-surepassid-black-release.aab',
                 googleCredentialsId: "${GOOGLE_CREDENTIAL_ID}",
                 rolloutPercentage: "${APP_ROLLOUT_PERCENTAGE}",
                 trackName: "${APP_TRACK_NAME}",
                 fromVersionCode: false
      }
    }

    stage('Promote GreenPush to Open Testing') {
      steps {
        androidApkMove filesPattern: 'authenticator-surepassid-greenPush-release.aab',
                 googleCredentialsId: "${GOOGLE_CREDENTIAL_ID}",
                 rolloutPercentage: "${APP_ROLLOUT_PERCENTAGE}",
                 trackName: 'Open Beta',
                 fromVersionCode: false
      }
    }

    stage('Promote GreenExpress to Open Testing') {
      steps {
        androidApkMove filesPattern: 'authenticator-surepassid-greenExpress-release.aab',
                 googleCredentialsId: "${GOOGLE_CREDENTIAL_ID}",
                 rolloutPercentage: "${APP_ROLLOUT_PERCENTAGE}",
                 trackName: "${APP_TRACK_NAME}",
                 fromVersionCode: false
      }
    }
  }
}
